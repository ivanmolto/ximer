"use strict";var app=angular.module("FullstackGeneratedApp",["ui.router","ui.bootstrap","fsaPreBuilt","ngStorage","ngMaterial","ngKnob","plangular"]);app.config(["plangularConfigProvider",function(e){e.clientId="45c5e6212ac58c73e7d05f8636a9bf22"}]),app.config(["$urlRouterProvider","$locationProvider",function(e,t){t.html5Mode(!0),e.otherwise("/")}]),app.run(["$rootScope","AuthService","$state",function(e,t,o){var n=function(e){return e.data&&e.data.authenticate};e.$on("$stateChangeStart",function(e,r,a){n(r)&&(t.isAuthenticated()||(e.preventDefault(),t.getLoggedInUser().then(function(e){e?o.go(r.name,a):o.go("login")})))})}]),app.config(["$stateProvider",function(e){e.state("forkweb",{url:"/forkweb",templateUrl:"js/forkweb/forkweb.html",controller:"ForkWebController"})}]),app.controller("ForkWebController",["$scope","$stateParams","$state","ProjectFct","AuthService","ForkFactory",function(e,t,o,n,r,a){a.getWeb().then(function(t){e.nodes=[];var o=[];t.forEach(function(t){var o=[];o.push(t);var n=o.concat(t.branch);e.nodes.push(n)}),console.log("network",e.nodes);var n=0;e.nodes.forEach(function(e){for(var t=1;t<e.length;t++){var r={source:n,target:t+n,weight:3};o.push(r)}n+=e.length});var r=[];r=r.concat.apply(r,e.nodes),console.log("PLEASE",o,r);var a=r,i=o,c=960,l=500,s=(d3.scale.category20(),d3.fisheye.circular().radius(120)),u=d3.layout.force().charge(-240).linkDistance(40).size([c,l]),p=d3.select("#ui").append("svg").attr("width",c).attr("height",l);p.append("rect").attr("class","background").attr("width",c).attr("height",l);var d=a.length;u.nodes(a).links(i),a.forEach(function(e,t){e.x=e.y=c/d*t}),u.start();for(var f=d;f>0;--f)u.tick();u.stop();var g=0,m=0;a.forEach(function(e){g+=e.x,m+=e.y}),g=g/d-c/2,m=m/d-l/2,a.forEach(function(e){e.x-=g,e.y-=m});var h=p.selectAll(".link").data(i).enter().append("line").attr("class","link").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}).style("stroke-width",function(e){return 2}),v=p.selectAll(".node").data(a).enter().append("circle").attr("class","node").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).attr("r",4.5).style("fill",function(e){return"blue"}).call(u.drag);p.on("mousemove",function(){s.focus(d3.mouse(this)),v.each(function(e){e.fisheye=s(e)}).attr("cx",function(e){return e.fisheye.x}).attr("cy",function(e){return e.fisheye.y}).attr("r",function(e){return 4.5*e.fisheye.z}),h.attr("x1",function(e){return e.source.fisheye.x}).attr("y1",function(e){return e.source.fisheye.y}).attr("x2",function(e){return e.target.fisheye.x}).attr("y2",function(e){return e.target.fisheye.y})})})}]),function(){if(!window.angular)throw new Error("I can't find Angular!");var e=angular.module("fsaPreBuilt",[]);e.factory("Socket",["$location",function(e){if(!window.io)throw new Error("socket.io not found!");return window.io(window.location.origin)}]),e.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),e.factory("AuthInterceptor",["$rootScope","$q","AUTH_EVENTS",function(e,t,o){var n={401:o.notAuthenticated,403:o.notAuthorized,419:o.sessionTimeout,440:o.sessionTimeout};return{responseError:function(o){return e.$broadcast(n[o.status],o),t.reject(o)}}}]),e.config(["$httpProvider",function(e){e.interceptors.push(["$injector",function(e){return e.get("AuthInterceptor")}])}]),e.service("AuthService",["$http","Session","$rootScope","AUTH_EVENTS","$q",function(e,t,o,n,r){function a(e){var r=e.data;return t.create(r.id,r.user),o.$broadcast(n.loginSuccess),r.user}this.isAuthenticated=function(){return!!t.user},this.getLoggedInUser=function(){return this.isAuthenticated()?r.when(t.user):e.get("/session").then(a)["catch"](function(){return null})},this.login=function(t){return e.post("/login",t).then(a)["catch"](function(e){return r.reject({message:"Invalid login credentials."})})},this.logout=function(){return e.get("/logout").then(function(){t.destroy(),o.$broadcast(n.logoutSuccess)})},this.signup=function(t){return console.log(t),e.post("/signup",t).then(a)["catch"](function(e){return r.reject({message:"Invalid signup credentials."})})}}]),e.service("Session",["$rootScope","AUTH_EVENTS",function(e,t){var o=this;e.$on(t.notAuthenticated,function(){o.destroy()}),e.$on(t.sessionTimeout,function(){o.destroy()}),this.id=null,this.user=null,this.create=function(e,t){this.id=e,this.user=t},this.destroy=function(){this.id=null,this.user=null}}])}(),app.config(["$stateProvider",function(e){e.state("loggedInHome",{url:"/home",templateUrl:"js/home/home.html",controller:"HomeController"}).state("home",{url:"/",templateUrl:"js/home/landing.html",controller:"LandingPageController",resolve:{checkIfLoggedIn:["AuthService","$state",function(e,t){e.getLoggedInUser().then(function(e){e&&t.go("loggedInHome")})}]}})}]),app.config(["$stateProvider",function(e){e.state("login",{url:"/login",templateUrl:"js/login/login.html",controller:"LoginCtrl"})}]),app.controller("LoginCtrl",["$scope","AuthService","$state",function(e,t,o){e.login={},e.error=null,e.sendLogin=function(n){e.error=null,t.login(n).then(function(){o.go("loggedInHome")})["catch"](function(){e.error="Invalid login credentials."})}}]),app.config(["$stateProvider",function(e){e.state("project",{url:"/project/:projectID",templateUrl:"js/project/project.html"})}]),app.controller("ProjectController",["$scope","$stateParams","$compile","RecorderFct","ProjectFct","ToneTrackFct","ToneTimelineFct","AuthService",function(e,t,o,n,r,a,i,c){var l=0;window.onblur=function(){l?(e.stop(),e.$digest()):l++},window.onbeforeunload=function(){return"Are you sure you want to leave this page before saving your work?"},window.onunload=function(){Tone.Transport.clearTimelines()},$(".timeline-container").scroll(function(){$(".trackMainSection").css({left:$(this).scrollLeft()})});var s=0;e.numMeasures=_.range(0,60),e.measureLength=1,n.recorderInit().then(function(t){e.recorder=t[0],e.analyserNode=t[1]})["catch"](function(e){alert("Error getting audio"),console.log(e)}),e.measureLength=1,e.tracks=[],e.loading=!0,e.projectId=t.projectID,e.position=0,e.playing=!1,e.currentlyRecording=!1,e.previewingId=null,e.zoom=100,r.getProjectInfo(e.projectId).then(function(t){var n=0;if(e.projectName=t.name,console.log("PROJECT",t),t.tracks.length)t.tracks.forEach(function(i){var c=[];if(t.tracks.forEach(function(e,t){e.url&&c++}),i.url){var l=function(){n++,n===c&&(e.loading=!1,e.$digest())},u=Math.max.apply(null,i.location);u+2>s&&(s=u+2),i.empty=!1,i.recording=!1,i.player=a.createPlayer(i.url,l),i.effectsRack=a.effectsInitialize(i.effectsRack),i.player.connect(i.effectsRack[0]),i.location.length?(i.location.forEach(function(e){console.log("TRACK",i,e);var t=a.createTimelineInstanceOfLoop(i.player,e);$("#measure"+e+".track"+r).first().append(o("<canvas width='198' height='98' position='"+e+"' timelineId='"+t+"' id='mdisplay"+r+"-"+e+"' class='item trackLoop"+r+"' style='position: absolute; background: url("+i.img+");' draggable></canvas>"))}),i.onTimeline=!0):i.onTimeline=!1,e.tracks.push(i)}else i.empty=!0,i.recording=!1,i.onTimeline=!1,i.previewing=!1,i.effectsRack=a.effectsInitialize([0,0,0,0]),i.player=null,e.tracks.push(i)});else{e.maxMeasure=32;for(var r=0;8>r;r++){var c={};c.empty=!0,c.recording=!1,c.onTimeline=!1,c.previewing=!1,c.silence=!1,c.effectsRack=a.effectsInitialize([0,0,0,0]),c.player=null,c.name="Track "+(r+1),c.location=[],e.tracks.push(c)}e.loading=!1}e.numMeasures=[],32>s&&(s=32);for(var r=0;s>r;r++)e.numMeasures.push(r);i.createTransport(t.endMeasure).then(function(t){e.metronome=t,e.metronome.on=!0}),i.changeBpm(t.bpm)}),e.jumpToMeasure=function(t){s>t&&(e.position=t,Tone.Transport.position=t.toString()+":0:0",e.movePlayhead(t))},e.movePlayhead=function(e){var t=document.getElementById("playbackHead");$("#timelinePosition").val(Tone.Transport.position.substr(1)),t.style.left=(200*e+300).toString()+"px"},e.zoomOut=function(){e.zoom-=10;var t=(e.zoom-10).toString()+"%";$(".timeline-container").css("zoom",t)},e.zoomIn=function(){e.zoom+=10;var t=(e.zoom+10).toString()+"%";$(".timeline-container").css("zoom",t)},e.addTrack=function(){},e.play=function(){e.playing=!0,Tone.Transport.position=e.position.toString()+":0:0",Tone.Transport.start()},e.pause=function(){e.playing=!1,e.metronome.stop(),i.stopAll(e.tracks),e.position=Tone.Transport.position.split(":")[0];var t=document.getElementById("playbackHead");$("#timelinePosition").val(":0:0"),t.style.left=(200*e.position+300).toString()+"px",Tone.Transport.pause()},e.stop=function(){e.playing=!1,e.metronome.stop(),i.stopAll(e.tracks),e.position=0;var t=document.getElementById("playbackHead");t.style.left="300px",Tone.Transport.stop(),$("#timelinePosition").val(":0:0"),$("#positionSelector").val("0"),e.previewingId&&(Tone.Transport.clearInterval(e.previewingId),e.previewingId=null)},e.nameChange=function(t){t?(e.nameError=!1,r.nameChange(t,e.projectId).then(function(e){})):(e.nameError="You must set a name!",e.projectName="Untitled",document.getElementById("projectNameInput").focus())},e.toggleMetronome=function(){0===e.metronome.volume.value?(e.metronome.volume.value=-100,e.metronome.on=!1):(e.metronome.volume.value=0,e.metronome.on=!0)},e.sendToAWS=function(){n.sendToAWS(e.tracks,e.projectId,e.projectName).then(function(e){console.log("response from sendToAWS",e)})},e.isLoggedIn=function(){return c.isAuthenticated()}}]),app.config(["$stateProvider",function(e){e.state("signup",{url:"/signup",templateUrl:"js/signup/signup.html",controller:"SignupCtrl"})}]),app.controller("SignupCtrl",["$scope","AuthService","$state",function(e,t,o){e.signup={},e.error=null,e.sendSignup=function(n){e.error=null,console.log(n),t.signup(n).then(function(){o.go("loggedInHome")})["catch"](function(){e.error="Invalid login credentials."})}}]),app.config(["$stateProvider",function(e){e.state("userProfile",{url:"/userprofile/:theID",templateUrl:"js/user/userprofile.html",controller:"UserController",data:{authenticate:!0}}).state("userProfile.artistInfo",{url:"/info",templateUrl:"js/user/info.html",controller:"UserController"}).state("userProfile.project",{url:"/projects",templateUrl:"js/user/projects.html",controller:"UserController"}).state("userProfile.followers",{url:"/followers",templateUrl:"js/user/followers.html",controller:"UserController"}).state("userProfile.following",{url:"/following",templateUrl:"js/user/following.html",controller:"UserController"})}]),app.controller("HomeController",["$scope","AuthService","ToneTrackFct","ProjectFct","$stateParams","$state","$mdToast",function(e,t,o,n,r,a,i){document.getElementsByTagName("navbar")[0].style.display="block",t.getLoggedInUser().then(function(t){e.loggedInUser=t,e.myfollowers=e.loggedInUser.followers.length,e.myfollowing=e.loggedInUser.following.length,e.myprojects=e.loggedInUser.projects.length}),e.isLoggedIn=function(){return t.isAuthenticated()},e.projects=function(){n.getProjectInfo().then(function(t){console.log("PROJCS",t),e.allProjects=t;var o=["https://i1.sndcdn.com/artworks-000121902503-djbqh6-t500x500.jpg","https://i1.sndcdn.com/artworks-000103418932-te6hs4-t500x500.jpg","https://i1.sndcdn.com/artworks-000121795778-cmq0x1-t500x500.jpg","https://i1.sndcdn.com/artworks-000121925392-2hw3hg-t500x500.jpg","https://i1.sndcdn.com/artworks-000122506583-ozzx85-t500x500.jpg","https://i1.sndcdn.com/artworks-000123015713-wuuuy9-t500x500.jpg","https://i1.sndcdn.com/artworks-000122546910-xmjb63-t500x500.jpg"];e.allProjects.forEach(function(e){e.backgroundImg=o[Math.floor(9*Math.random())]})})},e.projects(),e.makeFork=function(e){t.getLoggedInUser().then(function(t){console.log("loggedInUser",t),e.owner=t._id,e.forkID=e._id,delete e._id,console.log(e),i.show({hideDelay:2e3,position:"bottom right",template:"<md-toast> It's been forked </md-toast>"}),n.createAFork(e).then(function(e){console.log("Fork response is",e)})})};var c=!1;e.sampleTrack=function(t){c===!0&&e.player.stop(),o.createPlayer(t.url,function(t){e.player=t,c===!1?(c=!0,e.player.start()):c=!1})},e.getUserProfile=function(e){a.go("userProfile",{theID:e._id})}}]),app.controller("LandingPageController",["$scope","AuthService","ToneTrackFct","$state",function(e,t,o,n){document.getElementsByTagName("navbar")[0].style.display="none",e.goToForms=function(){function e(t){if(!(0>=t)){var o=document.documentElement.scrollHeight-window.scrollY,n=o/t*10;setTimeout(function(){window.scroll(0,window.scrollY+n),e(t-10)},10)}}e(1e3)},e.sendLogin=function(o){e.error=null,t.login(o).then(function(){n.go("loggedInHome")})["catch"](function(){e.error="Invalid login credentials."})},e.sendSignup=function(o){e.error=null,console.log(o),t.signup(o).then(function(){n.go("loggedInHome")})["catch"](function(){e.error="Invalid login credentials."})}}]),app.controller("NewProjectController",["$scope","AuthService","ProjectFct","$state",function(e,t,o,n){t.getLoggedInUser().then(function(t){e.user=t}),e.newProjectBut=function(){o.newProject(e.user).then(function(e){n.go("project",{projectID:e})})}}]),app.controller("TimelineController",["$scope","$stateParams","$localStorage","RecorderFct","ProjectFct","ToneTrackFct","ToneTimelineFct",function(e,t,o,n,r,a,i){e.numMeasures=[];for(var c=0;60>c;c++)e.numMeasures.push(c);e.measureLength=1,e.tracks=[],e.loading=!0,r.getProjectInfo("5594c20ad0759cd40ce51e14").then(function(t){var o=0;if(console.log("PROJECT",t),t.tracks.length)t.tracks.forEach(function(n){var r=function(){o++,o===t.tracks.length&&(e.loading=!1)};n.player=a.createPlayer(n.url,r),i.addLoopToTimeline(n.player,n.location),e.tracks.push(n)});else for(var n=0;6>n;n++){var r={};r.name="Track "+(n+1),r.location=[],e.tracks.push(r)}i.getTransport(t.endMeasure),i.changeBpm(t.bpm)}),e.record=function(t,o){t=t.toElement,console.log("start recording"),audioRecorder&&(t.classList.add("recording"),audioRecorder.clear(),audioRecorder.record(),window.setTimeout(function(){audioRecorder.stop(),t.classList.remove("recording"),audioRecorder.getBuffers(gotBuffers),window.setTimeout(function(){e.tracks[o].rawAudio=window.latestRecording},500)},2e3))},e.addTrack=function(){},e.sendToAWS=function(){var t=e.tracks.filter(function(e,t){return e.rawAudio?!0:void 0});n.sendToAWS(t,"5595a7faaa901ad63234f920").then(function(e){console.log("response from sendToAWS",e)})}}]),app.controller("UserController",["$scope","$state","AuthService","$stateParams","userFactory",function(e,t,o,n,r){o.getLoggedInUser().then(function(t){e.loggedInUser=t,r.getUserObj(n.theID).then(function(o){e.user=o;var r=["https://i1.sndcdn.com/artworks-000121902503-djbqh6-t500x500.jpg","https://i1.sndcdn.com/artworks-000103418932-te6hs4-t500x500.jpg","https://i1.sndcdn.com/artworks-000121795778-cmq0x1-t500x500.jpg","https://i1.sndcdn.com/artworks-000121925392-2hw3hg-t500x500.jpg","https://i1.sndcdn.com/artworks-000122506583-ozzx85-t500x500.jpg","https://i1.sndcdn.com/artworks-000123015713-wuuuy9-t500x500.jpg","https://i1.sndcdn.com/artworks-000122546910-xmjb63-t500x500.jpg"];e.user.projects.forEach(function(e){e.backgroundImg=r[Math.floor(9*Math.random())]}),e.user.profpic||(e.user.profpic="https://www.mdr101.com/wp-content/uploads/2014/05/placeholder-user.jpg");for(var a=0;a<o.followers.length;a++)console.log(n.theID,o.followers[a]._id),o.followers[a]._id===t._id&&(e.followStatus=!0)})}),e.follow=function(t){r.follow(t,e.loggedInUser).then(function(e){console.log("Follow controller response",e)}),e.followStatus=!0},e.displayWeb=function(){t.go("forkweb")}}]),app.factory("AnalyserFct",function(){var e=function(e,t,o){function n(){var r=3,a=1,i=Math.round(300/r),c=new Uint8Array(t.frequencyBinCount);t.getByteFrequencyData(c),e.clearRect(0,0,300,100),e.fillStyle="#F6D565",e.lineCap="round";for(var l=t.frequencyBinCount/i,s=0;i>s;++s){for(var u=0,p=Math.floor(s*l),d=0;l>d;d++)u+=c[p+d];u/=l;{c[s*l]}e.fillStyle="hsl( "+Math.round(360*s/i)+", 100%, 50%)",e.fillRect(s*r,100,a,-u)}o&&window.requestAnimationFrame(n)}window.requestAnimationFrame(n)},t=function(e){window.cancelAnimationFrame(e)};return{updateAnalysers:e,cancelAnalyserUpdates:t}}),app.factory("ForkFactory",["$http",function(e){var t=function(){return e.get("/api/forks").then(function(e){return e.data})};return{getWeb:t}}]),app.factory("HomeFct",["$http",function(e){return{getUser:function(t){return e.get("/api/user",{params:{_id:t}}).then(function(e){return e.data})}}}]),app.factory("ProjectFct",["$http",function(e){var t=function(t){var o=t||"all";return e.get("/api/projects/"+o||o).then(function(e){return e.data})},o=function(t){return e.post("/api/projects/",t).then(function(e){return e.data})},n=function(t){return e.post("/api/projects",{owner:t._id,name:"Untitled",bpm:120,endMeasure:32}).then(function(e){return e.data})},r=function(t,o){return e.put("/api/projects/"+o,{name:t}).then(function(e){return e.data})},a=function(t){return e["delete"]("/api/projects/"+t._id).then(function(e){return console.log("Delete Proj Fct",e.data),e.data})},i=function(t){return e.post("api/projects/soundcloud",{project:t}).then(function(e){return e.data})};return{getProjectInfo:t,createAFork:o,newProject:n,deleteProject:a,nameChange:r,uploadProject:i}}]),app.factory("RecorderFct",["$http","AuthService","$q","ToneTrackFct","AnalyserFct",function(e,t,o,n,r){var a=function(){return o(function(e,t){var o,n=window.AudioContext||window.webkitAudioContext,r=new n,a=window.navigator;a.getUserMedia=a.getUserMedia||a.webkitGetUserMedia||a.mozGetUserMedia||a.msGetUserMedia,a.cancelAnimationFrame||(a.cancelAnimationFrame=a.webkitCancelAnimationFrame||a.mozCancelAnimationFrame),a.requestAnimationFrame||(a.requestAnimationFrame=a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame),a.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}},function(t){var n=r.createGain(),a=r.createMediaStreamSource(t),i=a;i.connect(n);var c=r.createAnalyser();c.fftSize=2048,n.connect(c),o=new Recorder(n);var l=r.createGain();l.gain.value=0,n.connect(l),l.connect(r.destination),e([o,c])},function(e){alert("Error getting audio"),t(e)})})},i=function(e){e.clear(),e.record()},c=function(e,t){return t.stop(),new o(function(o,r){t.getBuffers(function(r){var a=document.getElementById("wavedisplay"+e),i=document.getElementById("waveForLoop"+e);drawBuffer(300,100,a.getContext("2d"),r[0]),drawBuffer(198,98,i.getContext("2d"),r[0]),window.latestBuffer=r[0],window.latestRecordingImage=i.toDataURL("image/png"),t.exportWAV(function(t){n.loopInitialize(t,e,"myRecording0.wav").then(o)})})})},l=function(e){return console.log("each track",e),new o(function(t,o){var n=new FileReader;e.rawAudio?(n.readAsDataURL(e.rawAudio),n.onloadend=function(e){t(n.result)}):t(null)})};return{sendToAWS:function(t,n,r){var a=t.map(l);return o.all(a).then(function(o){return t.forEach(function(e,t){o[t]&&(e.rawAudio=o[t],e.effectsRack=e.effectsRack.map(function(e){return console.log("EFFECT",e,e.wet.value),e.wet.value}))}),e.post("/api/aws/",{tracks:t,projectId:n,projectName:r}).then(function(e){return console.log("response in sendToAWSFactory",e),e.data})})},recorderInit:a,recordStart:i,recordStop:c}}]),app.factory("ToneTimelineFct",["$http","$q",function(e,t){var o=function(e){return new t(function(t,o){Tone.Transport.loop=!0,Tone.Transport.loopStart="0m",Tone.Transport.loopEnd=e.toString()+"m";var n=document.getElementById("playbackHead");c().then(function(e){return Tone.Transport.setInterval(function(){var t=Tone.Transport.position.split(":"),o=(200*parseInt(t[0])+50*parseInt(t[1])+500).toString()+"px";n.style.left=o,e.start()},"1m"),Tone.Transport.setInterval(function(){$("#timelinePosition").val(Tone.Transport.position.substr(1)),$("#positionSelector").val(Tone.Transport.position.substr(0,1)),e.start()},"4n"),t(e)})})},n=function(e){return Tone.Transport.bpm.value=e,Tone.Transport},r=function(e){e.forEach(function(e){e.player&&e.player.stop()})},a=function(e){e.forEach(function(e){e.player&&(e.player.volume.value=-100)})},i=function(e){e.forEach(function(e){e.player&&(e.player.volume.value=0)})},c=function(){return new t(function(e,t){var o=new Tone.Player("/api/wav/Click1.wav",function(){return e(o)}).toMaster()})};return{createTransport:o,changeBpm:n,createMetronome:c,stopAll:r,muteAll:a,unMuteAll:i}}]),app.factory("ToneTrackFct",["$http","$q",function(e,t){var o=function(e,t){var o=new Tone.Player(e,t);return o.toMaster(),o},n=function(e,o,n){return new t(function(t,r){var a=(window.URL||window.webkitURL).createObjectURL(e),i=document.getElementById("save"+o);i.href=a,i.download=n||"output"+o+".wav",window.latestRecording=e,window.latestRecordingURL=a;var c;c=new Tone.Player(i.href,function(){t(c)})})},r=function(e){var t=new Tone.Chorus;t.name="Chorus";var o=new Tone.Phaser;o.name="Phaser";var n=new Tone.Distortion;n.name="Distortion";var r=new Tone.PingPongDelay("4m");return r.name="Ping Pong",e.length&&(t.wet.value=e[0],o.wet.value=e[1],n.wet.value=e[2],r.wet.value=e[3]),t.connect(o),o.connect(n),n.connect(r),r.toMaster(),[t,o,n,r]},a=function(e,t){return Tone.Transport.setTimeline(function(){e.stop(),e.start()},t+"m")},i=function(e,o,n){return new t(function(t,r){console.log("old timeline id",o),Tone.Transport.clearTimeline(parseInt(o)),t(a(e,n))})},c=function(e){Tone.Transport.clearTimeline(parseInt(e))};return{createPlayer:o,loopInitialize:n,effectsInitialize:r,createTimelineInstanceOfLoop:a,replaceTimelineLoop:i,deleteTimelineLoop:c}}]),app.factory("userFactory",["$http",function(e){return{getUserObj:function(t){return e.get("api/users",{params:{_id:t}}).then(function(e){return e.data})},follow:function(t,o){return e.put("api/users",{userToFollow:t,loggedInUser:o}).then(function(e){return console.log("FollowUser Factory response",e.data),e.data})},unFollow:function(t,o){return e.put("api/users",{userToUnfollow:t,loggedInUser:o}).then(function(e){return console.log("unFollow response",e.data),e.data})}}}]),app.directive("draggable",function(){return function(e,t,o){var n=t[0];n.draggable=!0,n.addEventListener("dragstart",function(t){t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("Text",this.id),this.classList.add("drag");var n=e.track.location.indexOf(parseInt(o.position));return e.track.location.splice(n,1),!1},!1),n.addEventListener("dragend",function(e){return this.classList.remove("drag"),!1},!1)}}),app.directive("droppable",function(){return{scope:{drop:"&"},link:function(e,t){var o=t[0];o.addEventListener("dragover",function(e){return e.dataTransfer.dropEffect="move",e.preventDefault&&e.preventDefault(),this.classList.add("over"),!1},!1),o.addEventListener("dragenter",function(e){return this.classList.add("over"),!1},!1),o.addEventListener("dragleave",function(e){return this.classList.remove("over"),!1},!1),o.addEventListener("drop",function(t){t.stopPropagation&&t.stopPropagation(),this.classList.remove("over");var o,n,r=document.getElementById(t.dataTransfer.getData("Text"));this.classList.forEach(function(e){e.includes("track")&&(n=e.split("track")[1])}),r.classList.forEach(function(e){e.includes("trackLoop")&&(console.log(e.split("trackLoop")[1]),o=e.split("trackLoop")[1])});var a,i,c=parseInt(this.attributes.xposition.value),l=this.childNodes;if(console.log("ROWID",o,"trackIndex",n),parseInt(o)===parseInt(n)){for(var s=0;s<l.length;s++)if("canvas-box"===l[s].className){this.childNodes[s].appendChild(r),e.$parent.$parent.track.location.push(c),e.$parent.$parent.track.location.sort();for(var u=this.childNodes[s].childNodes,p=0;p<u.length;p++)"CANVAS"===u[p].nodeName&&(u[p].attributes.position.value=c,a=u[p].attributes.timelineId.value,console.log("OLD TIMELINE",a),i=u[p])}console.log("oldTimelineId",a),e.$parent.$parent.moveInTimeline(a,c).then(function(e){i.attributes.timelineid.value=e})}return e.$apply("drop()"),!1},!1)}}}),app.directive("followdirective",function(){return{restrict:"E",templateUrl:"js/common/directives/follow/followDirective.html",controller:"FollowDirectiveController"}}),app.controller("FollowDirectiveController",["$scope","$stateParams","$state","AuthService","userFactory",function(e,t,o,n,r){n.getLoggedInUser().then(function(n){e.loggedInUser=n,r.getUserObj(t.theID).then(function(r){e.user=r,"userProfile.followers"===o.current.name?e.follows=r.followers:(e.follows=r.following,t.theID===n._id&&(e.showButton=!0))})}),e.goToFollow=function(e){console.log("clicked",e),o.go("userProfile",{theID:e._id})},e.unFollow=function(t){console.log(e.follows);for(var o=0;o<e.follows.length;o++)if(e.follows[o]._id===t._id){var n=e.follows.splice(o,1);console.log("delete",n,e.follows)}r.unFollow(t,e.loggedInUser).then(function(t){console.log("succesful",t),e.$digest()})}}]),app.directive("fullstackLogo",function(){return{restrict:"E",templateUrl:"js/common/directives/fullstack-logo/fullstack-logo.html"}}),app.directive("loadingGif",function(){return{restrict:"E",templateUrl:"js/common/directives/loading-gif/loading.html"}}),app.directive("navbar",["$rootScope","AuthService","AUTH_EVENTS","$state",function(e,t,o,n){return{restrict:"E",scope:{},templateUrl:"js/common/directives/navbar/navbar.html",link:function(r){var a=function(){t.getLoggedInUser().then(function(e){e&&(r.userId=e._id,r.items=[{label:"Home",state:"home"},{label:"Profile",state:"userProfile({theID: userId})",auth:!0}])})};a(),r.user=null,r.isLoggedIn=function(){return t.isAuthenticated()},r.logout=function(){t.logout().then(function(){n.go("home")})};var i=function(){t.getLoggedInUser().then(function(e){r.user=e})},c=function(){r.user=null};i(),e.$on(o.loginSuccess,i),e.$on(o.loginSuccess,a),e.$on(o.logoutSuccess,c),e.$on(o.logoutSuccess,a),e.$on(o.sessionTimeout,c)}}}]),app.directive("projectdirective",function(){return{restrict:"E",templateUrl:"js/common/directives/project/projectDirective.html",controller:"projectdirectiveController"}}),app.controller("projectdirectiveController",["$scope","$stateParams","$state","ProjectFct","AuthService","$mdToast",function(e,t,o,n,r,a){r.getLoggedInUser().then(function(r){e.loggedInUser=r,e.displayAProject=function(n){console.log("THING",n),e.loggedInUser._id===t.theID&&o.go("project",{projectID:n._id})},e.makeFork=function(e){e.forkOrigin||(e.forkOrigin=e._id),a.show({hideDelay:2e3,position:"bottom right",template:"<md-toast> It's been forked </md-toast>"}),e.forkID=e._id,e.owner=r._id,delete e._id,n.createAFork(e).then(function(e){console.log("Fork response is",e)})},e.deleteProject=function(t){console.log(e.user.projects);for(var o=0;o<e.user.projects.length;o++)if(e.user.projects[o]._id===t._id){var r=e.user.projects.splice(o,1);console.log("delete",r,e.user.projects)}console.log("DeleteProject",t),n.deleteProject(t).then(function(e){console.log("Delete request is",e)})},e.postToSoundcloud=function(e){console.log("Uploading Project",e),n.uploadProject(e).then(function(e){console.log("Upload Request is",e)})}})}]),app.directive("ximTrack",["$rootScope","$stateParams","$compile","RecorderFct","ProjectFct","ToneTrackFct","ToneTimelineFct","AnalyserFct","$q",function(e,t,o,n,r,a,i,c,l){return{restrict:"E",templateUrl:"js/common/directives/track/track.html",link:function(e,t,r){e.effectWetnesses=[0,0,0,0],e.volume=new Tone.Volume,e.volume.volume.value=0,setTimeout(function(){e.track.location.forEach(function(t){var n=e.$parent.tracks.indexOf(e.track),r=a.createTimelineInstanceOfLoop(e.track.player,t);$("#measure"+t+".track"+n).first().append(o("<canvas width='198' height='98' position='"+t+"' timelineId='"+r+"' id='mdisplay"+n+"-"+t+"' class='item trackLoop"+n+"' style='position: absolute; background: url("+e.track.img+");' draggable></canvas>")(e))})},0),e.dropInTimeline=function(n,r){e.track.player.stop(),e.track.onTimeline=!0,e.track.previewing=!1;var i=t[0].getElementsByClassName("canvas-box");if(e.track.location.length)for(;e.track.location.indexOf(r)>-1;)r++;e.track.location.push(r),e.track.location.sort();var c=a.createTimelineInstanceOfLoop(e.track.player,r);angular.element(i[r]).append(o("<canvas width='198' height='98' position='"+r+"' timelineId='"+c+"' id='mdisplay"+n+"-"+r+"' class='item trackLoop"+n+"' style='position: absolute; background: url("+e.track.img+");' draggable></canvas>")(e))},e.moveInTimeline=function(t,o){return new l(function(n,r){a.replaceTimelineLoop(e.track.player,t,o).then(n)})},e.appearOrDisappear=function(n){var r=e.$parent.tracks.indexOf(e.track),i=e.track.location.indexOf(n);if(e.track.onTimeline)if(-1===i){var c=t[0].getElementsByClassName("canvas-box");e.track.location.push(n),e.track.location.sort();var l=a.createTimelineInstanceOfLoop(e.track.player,n);angular.element(c[n]).append(o("<canvas width='198' height='98' position='"+n+"' timelineId='"+l+"' id='mdisplay"+r+"-"+n+"' class='item trackLoop"+r+"' style='position: absolute; background: url("+e.track.img+");' draggable></canvas>")(e))}else{var s=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)},u=document.getElementById("mdisplay"+r+"-"+n);e.track.location.splice(i,1),a.deleteTimelineLoop(u.attributes.timelineid.value),s(u)}else console.log("NO DROP")},e.reRecord=function(t){e.track.empty=!0,e.track.onTimeline=!1,e.track.player=null,e.track.silence=!1,e.track.rawAudio=null,e.track.img=null,e.track.previewing=!1,e.track.effectsRack.forEach(function(e){e.dispose()}),e.track.effectsRack=a.effectsInitialize([0,0,0,0]),e.track.location=[];var o=document.getElementsByClassName("trackLoop"+t.toString());for(console.log("LOOPS",o);0!==o.length;){console.log("LOOPS ARR",o);for(var n=0;n<o.length;n++)o[n].parentNode.removeChild(o[n]);o=document.getElementsByClassName("trackLoop"+t.toString())}Tone.Transport.stop()},e.solo=function(){var t=e.$parent.tracks.map(function(t){return t!==e.track?(t.silence=!0,t):void 0}).filter(function(e){return e&&e.player?!0:void 0});i.muteAll(t),e.track.silence=!1,e.track.player.volume.value=0},e.silence=function(){e.track.silence?(e.track.player.volume.value=0,e.track.silence=!1):(e.track.player.volume.value=-100,e.track.silence=!0)},e.record=function(t){function o(){var e=3,t=1,n=Math.round(300/e),r=new Uint8Array(u.frequencyBinCount);u.getByteFrequencyData(r),s.clearRect(0,0,300,100),s.fillStyle="#F6D565",s.lineCap="round";for(var a=u.frequencyBinCount/n,i=0;n>i;++i){for(var l=0,p=Math.floor(i*a),d=0;a>d;d++)l+=r[p+d];l/=a;{r[i*a]}s.fillStyle="hsl( "+Math.round(360*i/n)+", 100%, 50%)",s.fillRect(i*e,100,t,-l)}c&&window.requestAnimationFrame(o)}function r(){n.recordStop(t,a).then(function(t){e.track.recording=!1,e.track.empty=!1,e.track.rawAudio=window.latestRecording,e.track.img=window.latestRecordingImage,e.track.player=t,t.connect(e.track.effectsRack[0]),c=!1,window.cancelAnimationFrame(p),e.$parent.metronome.stop(),e.$parent.currentlyRecording=!1,e.$parent.stop(),i.unMuteAll(e.$parent.tracks)})}var a=e.recorder,c=!0,l=document.getElementById("analyser"+t),s=l.getContext("2d"),u=e.analyserNode,p=window.requestAnimationFrame(o);if(e.track.recording=!0,e.track.empty=!0,n.recordStart(a),e.track.previewing=!1,e.$parent.currentlyRecording=!0,"stopped"===Tone.Transport.state){i.muteAll(e.$parent.tracks),e.$parent.metronome.start();var d=window.setInterval(function(){e.$parent.metronome.stop(),e.$parent.metronome.start()},500);window.setTimeout(function(){window.clearInterval(d),r()},4e3),window.setTimeout(function(){n.recordStart(a,t)},2050)}else var f=parseInt(Tone.Transport.position.split(":")[0])+1,g=f+1,m=Tone.Transport.setTimeline(function(){window.setTimeout(function(){n.recordStart(a,t)},50)},f.toString()+"m"),h=Tone.Transport.setTimeline(function(){Tone.Transport.clearTimeline(m),Tone.Transport.clearTimeline(h),r()},g.toString()+"m")},e.preview=function(t){var o;if(e.$parent.previewingId)console.log("ALREADY PREVIEWING");else{e.track.previewing=!0,"stopped"===Tone.Transport.state?(o=parseInt(Tone.Transport.position.split(":")[0]),
Tone.Transport.start()):o=parseInt(Tone.Transport.position.split(":")[0])+1;var n=Tone.Transport.setTimeline(function(){e.track.player.start();var t=Tone.Transport.setInterval(function(){e.track.player.stop(),e.track.player.start(),Tone.Transport.clearTimeline(n)},"1m");e.$parent.previewingId=t},o.toString()+"m")}},e.changeWetness=function(e,t){console.log(e),console.log(t),e.wet.value=t/1e3}}}}]);